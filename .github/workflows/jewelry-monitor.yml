name: é‡‘å·¥ç å¯¶ç›£æ§-Seleniumç‰ˆ

on:
  schedule:
    # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  
  # å¯ä»¥æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  selenium-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: å®‰è£ç€è¦½å™¨å’Œé©…å‹•ç¨‹å¼
      run: |
        echo "ğŸ”§ å®‰è£ Chrome å’Œ ChromeDriver..."
        
        # æ›´æ–°å¥—ä»¶åº«
        sudo apt-get update
        
        # å®‰è£ Chrome
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # æª¢æŸ¥ Chrome ç‰ˆæœ¬
        CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+' | head -1)
        echo "âœ… Chrome ä¸»ç‰ˆæœ¬: $CHROME_VERSION"
        
        # ä½¿ç”¨å›ºå®šç‰ˆæœ¬çš„ ChromeDriver (æ›´ç©©å®š)
        echo "ğŸ“¥ ä¸‹è¼‰ ChromeDriver..."
        
        # å˜—è©¦ä¸‹è¼‰æœ€æ–°ç©©å®šç‰ˆæœ¬
        if [ "$CHROME_VERSION" -ge "120" ]; then
          CHROMEDRIVER_VERSION="120.0.6099.109"
        elif [ "$CHROME_VERSION" -ge "115" ]; then
          CHROMEDRIVER_VERSION="115.0.5790.170"
        else
          CHROMEDRIVER_VERSION="114.0.5735.90"
        fi
        
        echo "ğŸ¯ ä½¿ç”¨ ChromeDriver ç‰ˆæœ¬: $CHROMEDRIVER_VERSION"
        
        # ä¸‹è¼‰ ChromeDriver
        wget -O chromedriver.zip "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
        
        # è§£å£“ç¸®ä¸¦å®‰è£
        unzip chromedriver.zip
        sudo mv chromedriver /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver
        
        # é©—è­‰å®‰è£
        echo "âœ… å®‰è£å®Œæˆï¼Œé©—è­‰ç‰ˆæœ¬:"
        google-chrome --version
        chromedriver --version
    
    - name: å®‰è£ Python å¥—ä»¶
      run: |
        echo "ğŸ“¦ å®‰è£ Python å¥—ä»¶..."
        pip install --upgrade pip
        pip install selenium==4.15.2
        pip install webdriver-manager==4.0.1
        pip install requests==2.31.0
        echo "âœ… Python å¥—ä»¶å®‰è£å®Œæˆ"
    
    - name: æ¸¬è©¦ Selenium ç’°å¢ƒ
      run: |
        echo "ğŸ§ª æ¸¬è©¦ Selenium ç’°å¢ƒ..."
        python -c "
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service

try:
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    
    service = Service('/usr/local/bin/chromedriver')
    driver = webdriver.Chrome(service=service, options=options)
    
    print('âœ… Selenium ç’°å¢ƒæ¸¬è©¦æˆåŠŸ')
    driver.quit()
except Exception as e:
    print(f'âŒ Selenium ç’°å¢ƒæ¸¬è©¦å¤±æ•—: {e}')
    exit(1)
"
    
    - name: åŸ·è¡Œ Selenium ç›£æ§
      run: |
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œ Selenium ç›£æ§..."
        cd src
        python selenium_monitor.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    - name: æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
      if: always()
      run: |
        echo "=== æª¢æŸ¥ç›£æ§çµæœ ==="
        ls -la
        if [ -d results ]; then
          echo "âœ… results ç›®éŒ„å­˜åœ¨"
          ls -la results/
        else
          echo "âš ï¸ æ²’æœ‰ results ç›®éŒ„"
        fi
        
        if [ -f selenium_matches.txt ]; then
          echo "âœ… æ‰¾åˆ° selenium_matches.txt"
          echo "æª”æ¡ˆå¤§å°: $(wc -l < selenium_matches.txt) è¡Œ"
          echo "æª”æ¡ˆå…§å®¹é è¦½:"
          head -10 selenium_matches.txt
        else
          echo "âš ï¸ æ²’æœ‰æ‰¾åˆ° selenium_matches.txt"
        fi
    
    - name: æäº¤çµæœåˆ°å„²å­˜åº«
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ çµæœæª”æ¡ˆ
        git add results/ || echo "æ²’æœ‰ results è³‡æ–™å¤¾"
        git add *.txt || echo "æ²’æœ‰ txt æª”æ¡ˆ"
        git add *.json || echo "æ²’æœ‰ json æª”æ¡ˆ"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "æ²’æœ‰æ–°çš„ç›£æ§çµæœéœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– Selenium ç›£æ§çµæœæ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push
        fi