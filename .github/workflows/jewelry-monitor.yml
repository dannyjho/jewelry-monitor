name: é‡‘å·¥ç å¯¶ç›£æ§-Seleniumç‰ˆ

on:
  schedule:
    # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  
  # å¯ä»¥æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  selenium-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: å®‰è£ Chrome ç€è¦½å™¨
      run: |
        # æ›´æ–°å¥—ä»¶åº«
        sudo apt-get update
        
        # å®‰è£å¿…è¦çš„ä¾è³´
        sudo apt-get install -y wget gnupg
        
        # æ·»åŠ  Google Chrome çš„å®˜æ–¹ GPG å¯†é‘°
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        
        # æ·»åŠ  Google Chrome çš„å®˜æ–¹ APT å„²å­˜åº«
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        
        # æ›´æ–°å¥—ä»¶åº«ä¸¦å®‰è£ Chrome
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # é©—è­‰å®‰è£
        google-chrome --version
        
    - name: å®‰è£ ChromeDriver
      run: |
        # ç²å– Chrome ç‰ˆæœ¬
        CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        echo "Chrome ç‰ˆæœ¬: $CHROME_VERSION"
        
        # ä¸‹è¼‰å°æ‡‰çš„ ChromeDriver
        CHROMEDRIVER_VERSION=$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION%%.*})
        echo "ChromeDriver ç‰ˆæœ¬: $CHROMEDRIVER_VERSION"
        
        # ä¸‹è¼‰ä¸¦å®‰è£ ChromeDriver
        wget -N https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip
        unzip -o chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver
        
        # é©—è­‰å®‰è£
        chromedriver --version
    
    - name: å®‰è£ Python å¥—ä»¶
      run: |
        pip install --upgrade pip
        pip install selenium==4.15.2
        pip install webdriver-manager==4.0.1
        pip install beautifulsoup4==4.12.2
        pip install lxml==4.9.3
        pip install requests==2.31.0
    
    - name: é©—è­‰ç’°å¢ƒ
      run: |
        echo "=== Python ç‰ˆæœ¬ ==="
        python --version
        echo "=== å·²å®‰è£çš„å¥—ä»¶ ==="
        pip list | grep -E "(selenium|webdriver|beautifulsoup|requests)"
        echo "=== Chrome è·¯å¾‘ ==="
        which google-chrome
        echo "=== ChromeDriver è·¯å¾‘ ==="
        which chromedriver
    
    - name: åŸ·è¡Œ Selenium ç›£æ§
      run: |
        cd src
        python selenium_monitor.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        DISPLAY: :0
    
    - name: æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
      if: always()
      run: |
        echo "=== æª¢æŸ¥ç›£æ§çµæœ ==="
        ls -la
        ls -la results/ || echo "æ²’æœ‰ results ç›®éŒ„"
        if [ -f selenium_matches.txt ]; then
          echo "âœ… æ‰¾åˆ° selenium_matches.txt"
          echo "æª”æ¡ˆå…§å®¹é è¦½:"
          head -20 selenium_matches.txt
        fi
    
    - name: æäº¤çµæœåˆ°å„²å­˜åº«
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ çµæœæª”æ¡ˆ
        git add results/ || echo "æ²’æœ‰ results è³‡æ–™å¤¾"
        git add *.txt || echo "æ²’æœ‰ txt æª”æ¡ˆ"
        git add *.json || echo "æ²’æœ‰ json æª”æ¡ˆ"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "æ²’æœ‰æ–°çš„ç›£æ§çµæœéœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– Selenium ç›£æ§çµæœæ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push
        fi