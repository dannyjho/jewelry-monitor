name: é‡‘å·¥ç å¯¶ç›£æ§-Seleniumç‰ˆ

on:
  schedule:
    # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  
  # å¯ä»¥æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  selenium-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: å®‰è£ç€è¦½å™¨ (ä½¿ç”¨ç³»çµ±å¥—ä»¶)
      run: |
        echo "ğŸ”§ ä½¿ç”¨ç³»çµ±å¥—ä»¶å®‰è£ Chrome å’Œ ChromeDriver..."
        
        # æ›´æ–°å¥—ä»¶åº«
        sudo apt-get update
        
        # å®‰è£ Chromium å’Œ ChromeDriver (æ›´ç©©å®š)
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          xvfb
        
        # æª¢æŸ¥å®‰è£çµæœ
        echo "âœ… å®‰è£å®Œæˆï¼Œæª¢æŸ¥ç‰ˆæœ¬:"
        chromium-browser --version || echo "Chromium æª¢æŸ¥å¤±æ•—"
        chromedriver --version || echo "ChromeDriver æª¢æŸ¥å¤±æ•—"
        
        # æª¢æŸ¥æª”æ¡ˆä½ç½®
        echo "ğŸ“ æª¢æŸ¥å®‰è£ä½ç½®:"
        which chromium-browser
        which chromedriver
        ls -la /usr/bin/chromium* || echo "æ‰¾ä¸åˆ° chromium"
        ls -la /usr/bin/chromedriver* || echo "æ‰¾ä¸åˆ° chromedriver"
    
    - name: å®‰è£ Python å¥—ä»¶
      run: |
        echo "ğŸ“¦ å®‰è£ Python å¥—ä»¶..."
        pip install --upgrade pip
        pip install selenium==4.15.2
        pip install requests==2.31.0
        echo "âœ… Python å¥—ä»¶å®‰è£å®Œæˆ"
        
        # æª¢æŸ¥å¥—ä»¶ç‰ˆæœ¬
        pip show selenium
    
    - name: æ¸¬è©¦ Selenium ç’°å¢ƒ
      run: |
        echo "ğŸ§ª æ¸¬è©¦ Selenium ç’°å¢ƒ..."
        python3 -c "
import sys
print(f'Python ç‰ˆæœ¬: {sys.version}')

try:
    from selenium import webdriver
    from selenium.webdriver.chrome.options import Options
    from selenium.webdriver.chrome.service import Service
    print('âœ… Selenium åŒ¯å…¥æˆåŠŸ')
    
    # è¨­å®šé¸é …
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.binary_location = '/usr/bin/chromium-browser'
    
    # å‰µå»ºæœå‹™
    service = Service('/usr/bin/chromedriver')
    
    # å‰µå»º driver
    driver = webdriver.Chrome(service=service, options=options)
    print('âœ… Chrome driver å‰µå»ºæˆåŠŸ')
    
    # æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
    driver.get('data:text/html,<html><body><h1>Test OK</h1></body></html>')
    title = driver.title
    print(f'âœ… é é¢æ¸¬è©¦æˆåŠŸï¼Œæ¨™é¡Œ: {title}')
    
    driver.quit()
    print('âœ… Selenium ç’°å¢ƒæ¸¬è©¦å®Œå…¨æˆåŠŸ')
    
except Exception as e:
    print(f'âŒ Selenium ç’°å¢ƒæ¸¬è©¦å¤±æ•—: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
"
    
    - name: åŸ·è¡Œ Selenium ç›£æ§
      run: |
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œ Selenium ç›£æ§..."
        cd src
        python selenium_monitor.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        DISPLAY: :99
    
    - name: æª¢æŸ¥åŸ·è¡Œçµæœ
      if: always()
      run: |
        echo "=== æª¢æŸ¥ç›£æ§çµæœ ==="
        
        # æª¢æŸ¥ç•¶å‰ç›®éŒ„
        echo "ğŸ“ ç•¶å‰ç›®éŒ„å…§å®¹:"
        ls -la
        
        # æª¢æŸ¥ results ç›®éŒ„
        if [ -d results ]; then
          echo "âœ… results ç›®éŒ„å­˜åœ¨"
          ls -la results/
        else
          echo "âš ï¸ æ²’æœ‰ results ç›®éŒ„"
        fi
        
        # æª¢æŸ¥åŒ¹é…çµæœæª”æ¡ˆ
        if [ -f selenium_matches.txt ]; then
          echo "âœ… æ‰¾åˆ° selenium_matches.txt"
          echo "æª”æ¡ˆå¤§å°: $(wc -l < selenium_matches.txt) è¡Œ"
          echo "--- æª”æ¡ˆå…§å®¹é è¦½ ---"
          head -15 selenium_matches.txt
        else
          echo "âš ï¸ æ²’æœ‰æ‰¾åˆ° selenium_matches.txt"
        fi
        
        # æª¢æŸ¥ JSON çµæœ
        if [ -f selenium_summary.json ]; then
          echo "âœ… æ‰¾åˆ° selenium_summary.json"
          cat selenium_summary.json
        else
          echo "âš ï¸ æ²’æœ‰æ‰¾åˆ° selenium_summary.json"
        fi
    
    - name: æäº¤çµæœåˆ°å„²å­˜åº«
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # æ·»åŠ æ‰€æœ‰çµæœæª”æ¡ˆ
        git add results/ 2>/dev/null || echo "æ²’æœ‰ results è³‡æ–™å¤¾"
        git add *.txt 2>/dev/null || echo "æ²’æœ‰ txt æª”æ¡ˆ"
        git add *.json 2>/dev/null || echo "æ²’æœ‰ json æª”æ¡ˆ"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²’æœ‰æ–°çš„ç›£æ§çµæœéœ€è¦æäº¤"
        else
          echo "ğŸ“ ç™¼ç¾æ–°çš„ç›£æ§çµæœï¼Œæº–å‚™æäº¤..."
          git commit -m "ğŸ¤– Selenium ç›£æ§çµæœ - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… çµæœå·²æäº¤åˆ°å„²å­˜åº«"
        fi