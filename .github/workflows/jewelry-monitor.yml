name: é‡‘å·¥ç å¯¶ç›£æ§-Seleniumç‰ˆ

on:
  schedule:
    # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  
  # å¯ä»¥æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  selenium-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: å®‰è£ç³»çµ±ä¾è³´
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          xvfb \
          chromium-browser \
          chromium-chromedriver
    
    - name: å®‰è£ Python å¥—ä»¶
      run: |
        pip install --upgrade pip
        pip install selenium
        pip install webdriver-manager
        pip install beautifulsoup4
        pip install lxml
        pip install requests
    
    - name: é©—è­‰ Chrome å®‰è£
      run: |
        chromium-browser --version
        chromedriver --version
        which chromium-browser
        which chromedriver
    
    - name: åŸ·è¡Œ Selenium ç›£æ§
      run: |
        cd src
        python selenium_monitor.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        DISPLAY: :99
    
    - name: æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ
      if: always()
      run: |
        echo "=== æª¢æŸ¥ç›£æ§çµæœ ==="
        ls -la
        ls -la results/ || echo "æ²’æœ‰ results ç›®éŒ„"
        if [ -f selenium_matches.txt ]; then
          echo "âœ… æ‰¾åˆ° selenium_matches.txt"
          echo "æª”æ¡ˆå¤§å°: $(wc -l < selenium_matches.txt) è¡Œ"
        fi
    
    - name: æäº¤çµæœåˆ°å„²å­˜åº«
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ çµæœæª”æ¡ˆ
        git add results/ || echo "æ²’æœ‰ results è³‡æ–™å¤¾"
        git add *.txt || echo "æ²’æœ‰ txt æª”æ¡ˆ"
        git add *.json || echo "æ²’æœ‰ json æª”æ¡ˆ"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "æ²’æœ‰æ–°çš„ç›£æ§çµæœéœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– Selenium ç›£æ§çµæœæ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push
        fi